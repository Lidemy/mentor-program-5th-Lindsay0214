<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>留言板＿＿串接API</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<style>
	.container {
		margin: 0 auto;
		padding: 100px 300px 0 300px;
	}

	.comments {
		border-top: 2px solid #d3d3d3;
		width: 700px;
		margin-top: 20px;
	}

	.btn {
		margin-top: 10px;
	}

	.card-body {
		border: 1px solid #d3d3d3;
		margin: 12px 0;
		border-radius: 6px;
	}
</style>
<script>
	const siteKey = '001'
	const loadMoreButtonHTML = '<button calss="load-more btn btn-primary">載入更多</button>'
	let lastId = null
	let isEnd = false

	const formTemplate = `
		<div>
			<h1>留言板</h1>
			<form class="add-comment-form">
				<div class="form-group">
					<label for="form-nickname">暱稱</label>
					<input name="nickname" type="text" class="form-control" id="form-nickname">
				</div>
				<div class="form-group">
					<label for="content-textarea">留言內容</label>
					<textarea name='content' class="form-control" id="content-textarea" rows="3"></textarea>
				</div>
				<button type="submit" class="btn btn-secondary">送出</button>
			</form>

			<div class="comments">
			</div>
		</div>
	`

	function init(options) {
		const siteKey = options.siteKey
		const apiURL = options.apiURL
		containerElement = $(options.containerSelector)
		console.log(containerSelector, containerElement)
		containerElement.append(formTemplate)
	}

	$(document).ready(() => {
		init({
			siteKey: '001',
			apiURL: 'http://192.168.64.2/lindsay/comments__api/',
			containerSelector: '.comment-area'
		})
	})

	// XSS escape
	function escapeOutput(toOutput) {
		return toOutput.replace(/\&/g, '&amp;')
			.replace(/\</g, '&lt;')
			.replace(/\>/g, '&gt;')
			.replace(/\"/g, '&quot;')
			.replace(/\'/g, '&#x27')
			.replace(/\//g, '&#x2F');
	}
	// 長留言的 function
	function appendCommentToDOM(container, comment, isPrepend) {
		const html = `   
			<div class="card-body">
				<h5 class="card-title">${escape(comment.nickname)}</h5>
				<p class="card-text">${escape(comment.content)}</p>
			</div>
			`
		// true or false 判斷要 prepend 還 append, 方便使用
		if (isPrepend) {
			container.prepend(html)
		} else {
			container.append(html)
		}
	}
	// get API
	$(document).ready(() => {
		const commentDOM = $('.comments')
		$.ajax({
			url: 'http://192.168.64.2/lindsay/comments__api/api_comments.php?site_key=001',
		}).done(function (data) {
			// confirm if get
			if (!data.ok) {
				alert(data.message)
				return
			}
			// append comment
			const comments = data.discussions;
			for (let comment of comments) {
				appendCommentToDOM(commentDOM, comment)
			}
		});
		// submit form
		$('.add-comment-form').submit(e => {
			e.preventDefault();
			const newCommentData = {
				site_key: '001',
				nickname: $('input[name=nickname]').val(),
				content: $('textarea[name=content]').val()
			}
			// POST new comment API
			function getComments(siteKey, before, cb) {

			}
			$.ajax({
				type: 'POST',
				url: 'http://192.168.64.2/lindsay/comments__api/api_add_comments.php',
				data: newCommentData
			}).done(function (data) {
				// console.log(data)
				if (!data.ok) {
					alert(data.message)
					return
				}
				// add comment 後清空留言板內容
				$('input[name=nickname]').val('')
				$('textarea[name=content]').val('')
				appendCommentToDOM(commentDOM, newCommentData, true)
			})
		})

	})
</script>

<body>
	<div class="container">
		<div class="comment-area"></div>
	</div>
</body>

</html>